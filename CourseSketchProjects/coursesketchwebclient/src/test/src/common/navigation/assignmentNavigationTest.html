<html>
<head>
    <meta charset="utf-8">
    <title>Assignment Navigation methods test</title>
    <!-- test Library -->
    <link rel="import" href="/test/testUtilities/testUtilities.html">
        <link rel="import"
              href="/test/testUtilities/fakePage/fakePageInclude.html">
        <link rel="import"
              href="/test/testUtilities/fakePage/fakeTestData/fakeTestDataInclude.html">

    <!-- file being tested. -->
    <script src="/src/common/navigation/assignmentNavigation.js" data-cover></script>
</head>
<body>
<div id="qunit"></div>
<div id="qunit-fixture"></div>

<script>

        QUnit.module("navigation index changing (problem style!)");
        QUnit.test("randomAssignment", function(assert) {
            var testNavigator = new AssignmentNavigator("900", 0, true);
            testNavigator.reloadAssignment();
            var index = testNavigator.getCurrentSubgroupIndex();
            testNavigator.gotoNext();
            assert.notEqual(undefined, testNavigator.getCurrentSubgroupIndex(), "testing randomness");
            var randomnessHappened = 0;
            var previousIndex = index;
            for (var k = 0; k < 100; k++) {
                // use goto next
                testNavigator.gotoNext();
                var newIndex = testNavigator.getCurrentSubgroupIndex();
                // ensures it is not staying at the same problem and not just going up by 1
                if (newIndex !== previousIndex + 1 && newIndex !== previousIndex) {
                    randomnessHappened++;
                }
                previousIndex = newIndex;
            }

            if (randomnessHappened > 50) {
                assert.ok(true, 'random happened sufficiently');
            } else {
                assert.ok(false, 'random only happened less than 50 times: ' + randomnessHappened);
            }
        });

        test("AssignmentNavigationForward", function(assert) {
            var testNavigator = new AssignmentNavigator("000", 0, true);
            testNavigator.reloadAssignment();
            var index = testNavigator.getCurrentSubgroupIndex();
            testNavigator.gotoNext();
            assert.equal(index + 1, testNavigator.getCurrentSubgroupIndex(), "testing that this assignment is in face correctly moving over");
        });

        test("AssignmentNavigationPrevious", function(assert) {
            var testNavigator = new AssignmentNavigator("000", 0, true);
            testNavigator.reloadAssignment();
            var index = testNavigator.getCurrentSubgroupIndex();
            testNavigator.gotoNext();
            assert.equal(index + 1, testNavigator.getCurrentSubgroupIndex(), "testing that this assignment is in face correctly moving over");

            testNavigator.gotoPrevious();
            assert.equal(index, testNavigator.getCurrentSubgroupIndex(), "testing that this assignment is in face correctly moving over");
        });

        test("goToProblem", function(assert) {
            var testNavigator = new AssignmentNavigator("000", 0, true);
            testNavigator.reloadAssignment();
            var index = testNavigator.getCurrentSubgroupIndex();
            testNavigator.goToSubgroup(index + 1);
            assert.equal(index + 1, testNavigator.getCurrentSubgroupIndex(), "testing that this assignment is in face correctly moving over");
        });

        test("looping", function(assert) {
            var testNavigator = new AssignmentNavigator("800", 0, true);
            testNavigator.reloadAssignment();
            var index = testNavigator.getCurrentSubgroupIndex();
            testNavigator.gotoNext();
            assert.equal(index + 1, testNavigator.getCurrentSubgroupIndex(), "testing that this assignment is in face correctly moving over");
            testNavigator.gotoNext();
            assert.equal(0, testNavigator.getCurrentSubgroupIndex(), "testing that this assignment is correctly resetting to zero");
            testNavigator.gotoPrevious();
            assert.equal(index + 1, testNavigator.getCurrentSubgroupIndex(), "testing that this assignment is correctly navigating back to the end");
        });
        QUnit.module("basic callbacks");
        QUnit.test("basic reload", function(assert) {
            var done = assert.async();
            var testNavigator = new AssignmentNavigator("800", 0, true);
            testNavigator.addCallback(function () {
                assert.ok(true);
                done();
            });
            testNavigator.reloadAssignment();
        });

        QUnit.test("next works", function(assert) {
            var done = assert.async();
            var testNavigator = new AssignmentNavigator("700", 0, true);
            testNavigator.reloadAssignment();
            testNavigator.addCallback(function () {
                assert.ok(true);
                done();
            });
            var index = testNavigator.getCurrentSubgroupIndex();
            console.log('index');
            testNavigator.gotoNext();
        });

        QUnit.test("previous works", function(assert) {
            var done = assert.async();
            var testNavigator = new AssignmentNavigator("800", 0, true);
            testNavigator.reloadAssignment();
            testNavigator.addCallback(function () {
                assert.ok(true);
                done();
            });
            testNavigator.gotoPrevious();
        });

        QUnit.test("basic reload with temp", function(assert) {
            var done = assert.async();
            var testNavigator = new AssignmentNavigator("800", 0, true);
            testNavigator.reloadAssignment(function () {
                assert.ok(true);
                done();
            });
        });

        QUnit.test("next works with temp", function(assert) {
            var done = assert.async();
            var testNavigator = new AssignmentNavigator("700", 0, true);
            testNavigator.reloadAssignment();
            var index = testNavigator.getCurrentSubgroupIndex();
            console.log('index');
            testNavigator.gotoNext(function () {
                assert.ok(true);
                done();
            });
        });

        QUnit.test("previous works with temp", function(assert) {
            var done = assert.async();
            var testNavigator = new AssignmentNavigator("800", 0, true);
            testNavigator.reloadAssignment();
            testNavigator.gotoPrevious(function () {
                assert.ok(true);
                done();
            });
        });

        QUnit.test("nested calls with temp", function(assert) {
            var done = assert.async(3);
            var testNavigator = new AssignmentNavigator("800", 0, true);
            testNavigator.reloadAssignment(function () {
                assert.ok(true);
                done();
                testNavigator.gotoNext(function () {
                    assert.ok(true);
                    done();
                    testNavigator.gotoPrevious(function () {
                        assert.ok(true);
                        done();
                    });
                });
            });
        });

        QUnit.module("navigation index changing (lecture style!)");
        QUnit.test("part navigation forward", function (assert) {
            var done = assert.async();
            var testNavigator = new AssignmentNavigator("1000", 0, false);
            testNavigator.reloadAssignment(function () {
                console.log("FINISHED RELOADING");
                testNavigator.clearAllCallbacks();
                var partIndex = testNavigator.getCurrentPartIndex();
                var groupIndex = testNavigator.getCurrentSubgroupIndex();
                testNavigator.gotoNext(function () {
                    var newPartIndex = testNavigator.getCurrentPartIndex();
                    var newGroupIndex = testNavigator.getCurrentSubgroupIndex();
                    assert.equal(newGroupIndex, groupIndex, "The group does not change indexes");
                    assert.equal(newPartIndex, partIndex + 1, "The part index is one larger");
                    done();
                });
            });
        });

        QUnit.test("part navigation forward twice (changing subgroup)", function (assert) {
            var done = assert.async(2);
            var testNavigator = new AssignmentNavigator("1000", 0, false);
            testNavigator.reloadAssignment(function () {
                console.log("FINISHED RELOADING");
                testNavigator.clearAllCallbacks();
                var partIndex = testNavigator.getCurrentPartIndex();
                var groupIndex = testNavigator.getCurrentSubgroupIndex();
                testNavigator.gotoNext(function () {
                    var newPartIndex = testNavigator.getCurrentPartIndex();
                    var newGroupIndex = testNavigator.getCurrentSubgroupIndex();
                    assert.equal(newGroupIndex, groupIndex, "The group does not change indexes");
                    assert.equal(newPartIndex, partIndex + 1, "The part index is one larger");
                    done();

                    testNavigator.gotoNext(function () {
                        var newPartIndex = testNavigator.getCurrentPartIndex();
                        var newGroupIndex = testNavigator.getCurrentSubgroupIndex();
                        assert.equal(newGroupIndex, groupIndex + 1, "The group does not change indexes");
                        assert.equal(newPartIndex, 0, "The part index is one larger");
                        done();
                    });
                });
            });
        });
</script>
</body>
